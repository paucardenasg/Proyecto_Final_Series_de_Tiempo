---
title: "Proyecto Final"
author: "Cárdenas Gallardo Paula Daniela y José Manuel Haces López"
date: "02-12-2022"
output: html_document
---

# Forecasting - Crecimiento de la Economía Mexicana
## *Proyecto Final | Series de Tiempo*

## 1. Introducción
El objetivo principal del proyecto es realizar *forecasts* del Producto Interno Bruto de México.
```{r, message=FALSE, warning=FALSE}
# Librerías necesarias
library(tsibble)
library(tidyverse)
library(lubridate)
library(tidyquant)
library(plotly)
library(shinyWidgets)
library(readxl)
library(forecast)
library(feasts)
library(fable)
library(tsibbledata)
library(fpp3)
```


## 2. Los datos
Se obtuvo el conjunto de datos a partir del archivo `data_gdp.csv`, el cual contiene $114$ registros (filas) y las siguientes $9$ variables (columnas):

+ `date` $\rightarrow$ Fecha en cuartos de año, desde 1993 Q1 hasta 2021 Q2
+ `gdp` $\rightarrow$ Producto Interno Bruto Real de México, en pesos mexicanos (MXN) (Gross Domestic Product (GDP))
+ `consumption` $\rightarrow$ Gasto real de consumo final del sector privado de México, en MXN (Real Private Sector Final Consumption Expenditure)
+ `gov_exp` $\rightarrow$ Gasto real en consumo final del gobierno general de México, en MXN (Real General Government Final Consumption Expenditure)
+ `imports` $\rightarrow$ Importaciones reales de bienes y servicios (Real Imports of Goods and Services) de México, en MXN
+ `exports` $\rightarrow$ Exportaciones reales de bienes y servicios de México, en MXN (Real Exports of Goods and Services)
+ `unemployment` $\rightarrow$ Porcentaje de tasa de desempleo de las personas de 15 años y más en México (Unemployment Rate: Aged 15 and Over: All Persons)
+ `usd` $\rightarrow$ Promedio de tasas diarias del tipo de cambio de moneda nacional a dólar estadounidense, en MXN (National Currency to US Dollar Exchange Rate: Average of Daily Rates)
+ `uncertainty` $\rightarrow$ Índice Mundial de Incertidumbre para México (World Uncertainty Index)

```{r}
# Importar los datos 
data <- read_csv("data_gdp.csv", show_col_type=FALSE) |> 
  mutate(date=yearquarter(date)) |> 
           as_tsibble(index=date)

head(data)
```
## 3. Objectivos
### 3.1 Investigación
Según el Banco Mundial de México, durante las últimas tres décadas, este país ha tenido un desempeño por debajo de lo esperado en términos de crecimiento, inclusión y reducción de la pobreza en comparación con países similares. La economía tuvo un crecimiento estimado en poco más del $2.0$% anual entre 1980 y 2018, lo que limita el progreso en la convergencia en relación con las economías de altos ingresos. La economía mexicana creció $4.8$% en 2021, luego de una caída de $8.1$% el año anterior debido a la pandemia de COVID-19.
En cuanto a al Producto Interno Bruto (PIB), que es la suma del valor (en dinero) de todos los bienes y servicios de uso final que genera un país o entidad federativa durante un período (comúnmente un año o trimestre), se dice que la economía de un país crece cuando su PIB aumenta de un período a otro. Por el contrario, cuando el PIB disminuye se dice que baja la actividad económica. Es sumamente útil para saber si la economía del país está creciendo o no, es decir, si se produjo más o menos que el año anterior. El cambio en el PIB a lo largo del tiempo es uno de los indicadores más importantes del crecimiento económico.

### 3.2 Análisis Exploratorio de Datos (EDA)
+ Visualización:
```{r}
# Linear plots
# GDP
data |>
  ggplot(aes(x=date, y=gdp, color=gdp)) +
  geom_line() +
      ggtitle("GDP over time") +
      ylab('MXN') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 

# consumption
data |>
  ggplot(aes(x=date, y=consumption, color=gdp)) +
  geom_line() +
      ggtitle("Consumption over time") +
      ylab('MXN') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 

# gov_exp
data |>
  ggplot(aes(x=date, y=gov_exp, color=gdp)) +
  geom_line() +
      ggtitle("General Government Final Consumption Expenditure over time") +
      ylab('MXN') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 
# imports
data |>
  ggplot(aes(x=date, y=imports, color=gdp)) +
  geom_line() +
      ggtitle("Imports over time") +
      ylab('MXN') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 
# exports
data |>
  ggplot(aes(x=date, y=exports, color=gdp)) +
  geom_line() +
      ggtitle("Exports over time") +
      ylab('MXN') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 
# unemployment
data |>
  ggplot(aes(x=date, y=unemployment, color=gdp)) +
  geom_line() +
      ggtitle("Unemployment over time") +
      ylab('%') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 

# usd
data |>
  ggplot(aes(x=date, y=usd, color=gdp)) +
  geom_line() +
      ggtitle("usd over time") +
      ylab('MXN') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 

# uncertainty
data |>
  ggplot(aes(x=date, y=uncertainty, color=gdp)) +
  geom_line() +
      ggtitle("Uncertainty over time") +
      ylab('Index') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 

```
  

+ Verificar si hay variables que requieren transformaciones o ajustes:
  Probar transformación logarítmica
  + *consumption*
  + *imports*
  + *exports*
```{r}
# consumption
data |>
  ggplot(aes(x=date, y=log(consumption), color=gdp)) +
  geom_line() +
      ggtitle("Log - Consumption over time") +
      ylab('MXN') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 
# imports
data |>
  ggplot(aes(x=date, y=log(imports), color=gdp)) +
  geom_line() +
      ggtitle("Log - Imports over time") +
      ylab('MXN') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 
# exports
data |>
  ggplot(aes(x=date, y=log(exports), color=gdp)) +
  geom_line() +
      ggtitle("Log - Exports over time") +
      ylab('MXN') + xlab('Time') + 
      theme(
        plot.title = element_text(color= '#24815C',
                                  size=14,
                                  face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                    size=11,
                                    face='bold.italic')) 
```
No hubo mucha diferencia, así que se trabajará con las originales.

```{r}
# Seasonal plots
# GDP
data |>
  gg_season(gdp) |> 
  ggplotly()

# consumption
data |>
  gg_season(consumption) |> 
  ggplotly()

# gov_exp
data |>
  gg_season(gov_exp) |> 
  ggplotly()

# imports
data |>
  gg_season(imports) |> 
  ggplotly()

# exports
data |>
  gg_season(exports) |> 
  ggplotly()

# unemployment
data |>
  gg_season(unemployment) |> 
  ggplotly()

# usd
data |>
  gg_season(usd) |> 
  ggplotly()

# uncertainty
data |>
  gg_season(uncertainty) |> 
  ggplotly()

```
```{r}
# Boxplot
# GDP
ggplot(data = data, aes(x = quarter(date), y = gdp,
                        group= quarter(date), color = as.factor(quarter(date)))) +
  geom_boxplot() +
  ggtitle("GDP per quarter") +
  ylab('MXN') + xlab('Quarter') + 
  theme(plot.title = element_text(color= '#24815C',
                              size=14,
                              face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        legend.title=element_blank()) 

# consumption
ggplot(data = data, aes(x = quarter(date), y = consumption,
                        group= quarter(date), color = as.factor(quarter(date)))) +
  geom_boxplot() +
  ggtitle("Consumption per quarter") +
  ylab('MXN') + xlab('Quarter') + 
  theme(plot.title = element_text(color= '#24815C',
                              size=14,
                              face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        legend.title=element_blank()) 

# gov_exp
ggplot(data = data, aes(x = quarter(date), y = gov_exp,
                        group= quarter(date), color = as.factor(quarter(date)))) +
  geom_boxplot() +
  ggtitle("Government Final Consumption per quarter") +
  ylab('MXN') + xlab('Quarter') + 
  theme(plot.title = element_text(color= '#24815C',
                              size=14,
                              face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        legend.title=element_blank()) 

# imports
ggplot(data = data, aes(x = quarter(date), y = imports,
                        group= quarter(date), color = as.factor(quarter(date)))) +
  geom_boxplot() +
  ggtitle("Imports per quarter") +
  ylab('MXN') + xlab('Quarter') + 
  theme(plot.title = element_text(color= '#24815C',
                              size=14,
                              face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        legend.title=element_blank()) 

# exports
ggplot(data = data, aes(x = quarter(date), y = exports,
                        group= quarter(date), color = as.factor(quarter(date)))) +
  geom_boxplot() +
  ggtitle("Exports per quarter") +
  ylab('MXN') + xlab('Quarter') + 
  theme(plot.title = element_text(color= '#24815C',
                              size=14,
                              face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        legend.title=element_blank()) 

# unemployment
ggplot(data = data, aes(x = quarter(date), y = unemployment,
                        group= quarter(date), color = as.factor(quarter(date)))) +
  geom_boxplot() +
  ggtitle("Unemployment per quarter") +
  ylab('%') + xlab('Quarter') + 
  theme(plot.title = element_text(color= '#24815C',
                              size=14,
                              face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        legend.title=element_blank()) 

# usd
ggplot(data = data, aes(x = quarter(date), y = usd,
                        group= quarter(date), color = as.factor(quarter(date)))) +
  geom_boxplot() +
  ggtitle("MXN change to USD per quarter") +
  ylab('MXN') + xlab('Quarter') + 
  theme(plot.title = element_text(color= '#24815C',
                              size=14,
                              face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        legend.title=element_blank()) 

# uncertainty
ggplot(data = data, aes(x = quarter(date), y = uncertainty,
                        group= quarter(date), color = as.factor(quarter(date)))) +
  geom_boxplot() +
  ggtitle("Uncertainty per quarter") +
  ylab('Index') + xlab('Quarter') + 
  theme(plot.title = element_text(color= '#24815C',
                              size=14,
                              face='bold'),
        axis.title.x = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        axis.title.y = element_text(color='#1B1818',
                                size=11,
                                face='bold.italic'),
        legend.title=element_blank()) 
```

+ Identificar datos atípicos:
  + *gdp* $\rightarrow$ pandemia
  + *consumption* $\rightarrow$ pandemia
  + *imports* $\rightarrow$ pandemia
  + *exports* $\rightarrow$ pandemia
  + *unemployment* $\rightarrow$ crisis de 1994-1995

```{r}
# STL decomposition
# GDP
data |> 
  model(stl = STL(gdp, robust = TRUE)) |> 
  components() |> 
  autoplot() |> 
  ggplotly()

# consumption
data |> 
  model(stl = STL(consumption, robust = TRUE)) |> 
  components() |> 
  autoplot() |> 
  ggplotly()

# gov_exp
data |> 
  model(stl = STL(gov_exp, robust = TRUE)) |> 
  components() |> 
  autoplot() |> 
  ggplotly()

# imports
data |> 
  model(stl = STL(imports, robust = TRUE)) |> 
  components() |> 
  autoplot() |> 
  ggplotly()

# exports
data |> 
  model(stl = STL(exports, robust = TRUE)) |> 
  components() |> 
  autoplot() |> 
  ggplotly()

# unemployment
data |> 
  model(stl = STL(unemployment, robust = TRUE)) |> 
  components() |> 
  autoplot() |> 
  ggplotly()

# usd
data |> 
  model(stl = STL(usd, robust = TRUE)) |> 
  components() |> 
  autoplot() |> 
  ggplotly()

# uncertainty
data |> 
  model(stl = STL(uncertainty, robust = TRUE)) |> 
  components() |> 
  autoplot() |> 
  ggplotly()
```

### 3.3 Especificación del Modelo
+ Intentar:
    + Transformations/adjustments
    + Forecasting using decomposition
    + Model combinations
    + Handling outliers
    + For multivariate models, using dummy variables
    + Fourier transformations to account for seasonality
    
### 3.4 Forecasting
Producir predicción un año adelante (hasta 2022 Q2)

### 3.5 Desempeño
Considerar el MAPE

## Referencias Bibliográficas
Banco Mundial. (2022) *México: panorama general*. Consultado el 24 de noviembre de 2022, de https://www.bancomundial.org/es/country/mexico/overview

INEGI. (2020) *Producto Interno Bruto (PIB)*. Consultado el 24 de noviembre de 2022, de
https://cuentame.inegi.org.mx/economia/pib.aspx?tema=e